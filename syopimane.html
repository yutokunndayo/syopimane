<!DOCTYPE html>
<html>
<head>
  <title>買い物カゴスキャナー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    button { margin: 0 4px; }
  </style>
</head>
<body>
  <h2>買い物バーコードスキャン</h2>
  <div id="scanner" style="width: 100%; max-width: 400px;"></div>
  <p id="barcode-result">バーコード: なし</p>
  <p id="total">合計金額: ¥0</p>
  <button onclick="shareCart()">🧾 カゴ内容をQR共有</button>
  <div id="qrcode" style="margin: 1em 0;"></div>

  <h3>🛒 カゴの中身</h3>
  <table>
    <thead>
      <tr><th>商品名</th><th>価格</th><th>個数</th><th>操作</th></tr>
    </thead>
    <tbody id="cart-body"></tbody>
  </table>

  <script>
    let productDB = JSON.parse(localStorage.getItem('productDB')) || {};
    let cartItems = {};

    function updateTotal() {
      let total = 0;
      for (let code in cartItems) {
        let item = cartItems[code];
        total += item.price * item.quantity;
      }
      document.getElementById("total").innerText = `合計金額: ¥${total}`;
    }

    function renderCart() {
      let html = "";
      for (let code in cartItems) {
        let item = cartItems[code];
        html += `
          <tr>
            <td>${item.name}</td>
            <td>¥${item.price}</td>
            <td>
              <button onclick="changeQuantity('${code}', -1)">−</button>
              ${item.quantity}
              <button onclick="changeQuantity('${code}', 1)">＋</button>
            </td>
            <td><button onclick="removeItem('${code}')">削除</button></td>
          </tr>
        `;
      }
      document.getElementById("cart-body").innerHTML = html;
      updateTotal();
    }

    function handleBarcode(barcode) {
      document.getElementById("barcode-result").innerText = "バーコード: " + barcode;
      if (productDB[barcode]) {
        addToCart(barcode);
      } else {
        let name = prompt("商品名を入力してください:");
        let price = parseFloat(prompt("価格を入力してください:"));
        if (name && !isNaN(price)) {
          productDB[barcode] = { name, price };
          localStorage.setItem('productDB', JSON.stringify(productDB));
          addToCart(barcode);
        }
      }
    }

    function addToCart(barcode) {
      let product = productDB[barcode];
      if (!cartItems[barcode]) {
        cartItems[barcode] = { ...product, quantity: 0 };
      }
      cartItems[barcode].quantity++;
      renderCart();
    }

    function changeQuantity(barcode, delta) {
      if (cartItems[barcode]) {
        cartItems[barcode].quantity += delta;
        if (cartItems[barcode].quantity <= 0) {
          delete cartItems[barcode];
        }
        renderCart();
      }
    }

    function removeItem(barcode) {
      delete cartItems[barcode];
      renderCart();
    }

    function shareCart() {
      const data = JSON.stringify(cartItems);
      const encoded = encodeURIComponent(data);
      const url = `${location.origin}${location.pathname}?cart=${encoded}`;
      document.getElementById("qrcode").innerHTML = "";
      new QRCode(document.getElementById("qrcode"), url);
    }

    window.addEventListener('load', () => {
      const params = new URLSearchParams(window.location.search);
      if (params.has('cart')) {
        try {
          cartItems = JSON.parse(decodeURIComponent(params.get('cart')));
          renderCart();
        } catch (e) {
          console.error("QRデータの読み込みに失敗しました", e);
        }
      }
    });

    Quagga.init({
      inputStream: {
        type: "LiveStream",
        target: document.querySelector('#scanner'),
        constraints: {
          facingMode: "environment"
        }
      },
      decoder: {
        readers: ["ean_reader"]
      }
    }, function (err) {
      if (err) {
        console.error(err);
        return;
      }
      Quagga.start();
    });

    Quagga.onDetected((data) => {
      const barcode = data.codeResult.code;
      if (barcode) {
        Quagga.pause();
        handleBarcode(barcode);
        setTimeout(() => Quagga.start(), 1500);
      }
    });
  </script>
</body>
</html>
