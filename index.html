<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>æ¥½å¤©ã‚¹ã‚­ãƒ£ãƒŠğŸ›’</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {font-family:sans-serif; max-width:600px; margin:auto; padding:1em; background:#f8f9fa;}
    h1 {text-align:center;}
    #reader {margin:1em auto; max-width:400px;}
    #weather {text-align:center; margin-bottom:1em;}
    table {width:100%; border-collapse:collapse; margin-top:1em; background:white;}
    th, td {border:1px solid #ccc; padding:0.5em; text-align:center;}
    td[contenteditable] {background:#eef;}
    button {padding:0.3em 0.6em; margin:0 0.2em; background:#007bff; color:white; border:none; border-radius:4px;}
  </style>
</head>
<body>
  <h1>ğŸ“· æ¥½å¤©ã‚¹ã‚­ãƒ£ãƒŠ</h1>
  <div id="weather">å¤©æ°—å–å¾—ä¸­â€¦</div>
  <div id="reader"></div>
  <p>åˆè¨ˆé‡‘é¡ï¼š<strong id="total">0</strong> å††</p>

  <table>
    <thead><tr><th>å•†å“å</th><th>ä¾¡æ ¼</th><th>å€‹æ•°</th><th>æ“ä½œ</th></tr></thead>
    <tbody id="cart-body"></tbody>
  </table>

  <audio id="beep-sound" src="beep.mp3" preload="auto"></audio>

  <script>
    // âš™ï¸ æ¥½å¤©APIæƒ…å ±
    const RAKUTEN_APPID = "1085166348461729249";

    const cartBody = document.getElementById("cart-body");
    const totalEl = document.getElementById("total");
    const beep = document.getElementById("beep-sound");

    const productDB = JSON.parse(localStorage.getItem("productDB") || "{}");
    const cart = {};
    let lastScanned = null;
    let paused = false;

    function updateCart() {
      cartBody.innerHTML = "";
      let total = 0;
      for (const code in cart) {
        const qty = cart[code];
        const p = productDB[code] || { name: "æœªç™»éŒ²", price: 0 };
        total += p.price * qty;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td contenteditable onblur="editName('${code}', this.textContent)">${p.name}</td>
          <td contenteditable onblur="editPrice('${code}', this.textContent)">${p.price}</td>
          <td>${qty}</td>
          <td>
            <button onclick="changeQty('${code}', -1)">âˆ’</button>
            <button onclick="changeQty('${code}', 1)">ï¼‹</button>
            <button onclick="removeItem('${code}')">ğŸ—‘ï¸</button>
          </td>
        `;
        cartBody.appendChild(tr);
      }
      totalEl.textContent = total;
      localStorage.setItem("productDB", JSON.stringify(productDB));
    }

    function changeQty(c, d) {
      cart[c] = (cart[c] || 0) + d;
      if (cart[c] <= 0) delete cart[c];
      updateCart();
    }
    function removeItem(c) {
      delete cart[c];
      updateCart();
    }
    function editName(c, n) { if (productDB[c]) productDB[c].name = n; updateCart(); }
    function editPrice(c, v) {
      const nv = parseInt(v,10);
      if (!isNaN(nv) && productDB[c]) productDB[c].price = nv;
      updateCart();
    }

    function fetchRakuten(code, cb) {
      fetch(`https://app.rakuten.co.jp/services/api/IchibaItem/Search/20170706?format=json&applicationId=${RAKUTEN_APPID}&hits=1&jan=${code}`)
        .then(r => r.json())
        .then(d => {
          const item = d.Items?.[0]?.Item;
          if (item) cb({ name: item.itemName, price: parseInt(item.itemPrice,10) });
          else cb({});
        })
        .catch(() => cb({}));
    }

    function onScan(code) {
      if (paused || code === lastScanned) return;
      paused = true;
      lastScanned = code;
      beep.play();

      if (productDB[code]) {
        cart[code] = (cart[code]||0) + 1;
        updateCart();
        resume();
      } else {
        fetchRakuten(code, data => {
          const name = data.name || prompt("å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š") || "ä¸æ˜";
          const price = data.price || parseInt(prompt("ä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š"),10);
          if (isNaN(price)) { alert("ä¾¡æ ¼ã‚¨ãƒ©ãƒ¼"); resume(); return; }
          productDB[code] = { name, price };
          cart[code] = 1;
          updateCart();
          resume();
        });
      }
    }

    function resume() { setTimeout(()=>{ paused=false; lastScanned=null; }, 1500); }

    Html5Qrcode.getCameras().then(devs => {
      if (devs && devs.length) {
        const cam = devs.find(d=>/back/i.test(d.label))||devs[0];
        new Html5Qrcode("reader").start(cam.id, { fps:10, qrbox:250 }, onScan);
      } else alert("ã‚«ãƒ¡ãƒ©æœªæ¤œå‡º");
    });

    // ğŸŒ¦ å¤©æ°—è¡¨ç¤ºï¼ˆOpen-Meteoï¼‰
    navigator.geolocation?.getCurrentPosition(p => {
      fetch(`https://api.open-meteo.com/v1/forecast?latitude=${p.coords.latitude}&longitude=${p.coords.longitude}&current_weather=true&timezone=auto`)
        .then(r=>r.json())
        .then(d=>{
          const w = d.current_weather;
          document.getElementById("weather").textContent =
            `ç¾åœ¨ã®å¤©æ°—ï¼š${w.temperature}â„ƒã€${w.weathercode}`;
        }).catch(()=>document.getElementById("weather").textContent="å¤©æ°—å–å¾—å¤±æ•—");
    }, () => { document.getElementById("weather").textContent="ä½ç½®æƒ…å ±ã‚’è¨±å¯ã—ã¦ãã ã•ã„"; });
  </script>
</body>
</html>
