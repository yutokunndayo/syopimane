<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>æœ€æ–°ã‚¹ã‚­ãƒ£ãƒŠğŸ›’</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {font-family:sans-serif; max-width:600px; margin:auto; padding:1em; background:#f8f9fa;}
    h1 {text-align:center;}
    #reader {margin:1em auto; max-width:400px;}
    #weather {text-align:center; margin-bottom:1em; font-weight: bold;}
    table {width:100%; border-collapse:collapse; margin-top:1em; background:white;}
    th, td {border:1px solid #ccc; padding:0.5em; text-align:center;}
    td[contenteditable] {background:#eef;}
    button {padding:0.3em 0.6em; margin:0 0.2em; background:#007bff; color:white; border:none; border-radius:4px;}
  </style>
</head>
<body>
  <h1>ğŸ“· æ¥½å¤©ã‚¹ã‚­ãƒ£ãƒŠ</h1>
  <div id="weather">å¤©æ°—å–å¾—ä¸­â€¦</div>
  <div id="reader"></div>
  <p>åˆè¨ˆé‡‘é¡ï¼š<strong id="total">0</strong> å††</p>

  <table>
    <thead><tr><th>å•†å“å</th><th>ä¾¡æ ¼</th><th>å€‹æ•°</th><th>æ“ä½œ</th></tr></thead>
    <tbody id="cart-body"></tbody>
  </table>

  <audio id="beep-sound" src="beep.mp3" preload="auto"></audio>

  <script>
    const RAKUTEN_APPID = "1085166348461729249";
    const cartBody = document.getElementById("cart-body");
    const totalEl = document.getElementById("total");
    const beep = document.getElementById("beep-sound");

    const cart = {};
    let lastScanned = null;
    let paused = false;

    function updateCart() {
      cartBody.innerHTML = "";
      let total = 0;
      for (const code in cart) {
        const item = cart[code];
        total += item.price * item.qty;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td contenteditable onblur="editName('${code}', this.textContent)">${item.name}</td>
          <td contenteditable onblur="editPrice('${code}', this.textContent)">${item.price}</td>
          <td>${item.qty}</td>
          <td>
            <button onclick="changeQty('${code}', -1)">âˆ’</button>
            <button onclick="changeQty('${code}', 1)">ï¼‹</button>
            <button onclick="removeItem('${code}')">ğŸ—‘ï¸</button>
          </td>
        `;
        cartBody.appendChild(tr);
      }
      totalEl.textContent = total;
    }

    function changeQty(code, delta) {
      cart[code].qty += delta;
      if (cart[code].qty <= 0) delete cart[code];
      updateCart();
    }

    function removeItem(code) {
      delete cart[code];
      updateCart();
    }

    function editName(code, newName) {
      cart[code].name = newName;
      updateCart();
    }

    function editPrice(code, newPrice) {
      const price = parseInt(newPrice, 10);
      if (!isNaN(price)) {
        cart[code].price = price;
        updateCart();
      }
    }

    function fetchRakuten(code, callback) {
      fetch(`https://app.rakuten.co.jp/services/api/IchibaItem/Search/20170706?format=json&applicationId=${RAKUTEN_APPID}&hits=1&jan=${code}`)
        .then(r => r.json())
        .then(d => {
          const item = d.Items?.[0]?.Item;
          if (item) {
            callback({ name: item.itemName, price: parseInt(item.itemPrice, 10) });
          } else {
            callback({});
          }
        })
        .catch(() => callback({}));
    }

    function onScan(code) {
      if (paused || code === lastScanned) return;
      paused = true;
      lastScanned = code;
      beep.play();

      fetchRakuten(code, data => {
        const name = data.name || prompt("å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š") || "ä¸æ˜";
        const price = data.price || parseInt(prompt("ä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š"), 10);
        if (isNaN(price)) {
          alert("ä¾¡æ ¼ãŒç„¡åŠ¹ã§ã™");
          resume();
          return;
        }
        cart[code] = { name, price, qty: 1 };
        updateCart();
        resume();
      });
    }

    function resume() {
      setTimeout(() => {
        paused = false;
        lastScanned = null;
      }, 1500);
    }

    Html5Qrcode.getCameras().then(devices => {
      if (devices && devices.length) {
        const cam = devices.find(d => /back/i.test(d.label)) || devices[0];
        new Html5Qrcode("reader").start(cam.id, { fps: 10, qrbox: 250 }, onScan);
      } else {
        alert("ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
      }
    });

    // å¤©æ°—ã‚³ãƒ¼ãƒ‰ â†’ æ—¥æœ¬èªã«å¤‰æ›
    function getWeatherText(code) {
      const map = {
        0: "å¿«æ™´", 1: "æ™´ã‚Œ", 2: "ã‚„ã‚„æ›‡ã‚Š", 3: "æ›‡ã‚Š",
        45: "éœ§", 48: "éœ§", 51: "éœ§é›¨", 53: "éœ§é›¨", 55: "éœ§é›¨",
        61: "å¼±ã„é›¨", 63: "é›¨", 65: "å¼·ã„é›¨",
        66: "æ°·é›¨", 67: "æ°·é›¨", 71: "å¼±ã„é›ª", 73: "é›ª", 75: "å¼·ã„é›ª",
        80: "ã«ã‚ã‹é›¨", 81: "é›¨", 82: "æ¿€ã—ã„é›¨", 95: "é›·é›¨", 99: "é›·é›¨"
      };
      return map[code] || "ä¸æ˜";
    }

    // å¤©æ°—å–å¾—
    navigator.geolocation?.getCurrentPosition(pos => {
      const { latitude, longitude } = pos.coords;
      fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&timezone=auto`)
        .then(r => r.json())
        .then(d => {
          const w = d.current_weather;
          const text = getWeatherText(w.weathercode);
          document.getElementById("weather").textContent = `ç¾åœ¨ã®å¤©æ°—ï¼š${text}ï¼ˆ${w.temperature}â„ƒï¼‰`;
        })
        .catch(() => {
          document.getElementById("weather").textContent = "å¤©æ°—å–å¾—å¤±æ•—";
        });
    }, () => {
      document.getElementById("weather").textContent = "ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ";
    });
  </script>
</body>
</html>
