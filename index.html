<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>バーコードスキャナー</title>
  <style>
    body { font-family: sans-serif; padding: 1em; max-width: 600px; margin: auto; background: #f2f2f2; }
    header { text-align: center; }
    #scanner-container { margin: 1em 0; text-align: center; }
    #weather { margin: 1em 0; font-weight: bold; }
    table { width: 100%; border-collapse: collapse; background: white; }
    th, td { padding: 0.5em; border: 1px solid #ccc; text-align: center; }
    #total-price { margin-top: 1em; font-size: 1.2em; font-weight: bold; }
    video { width: 100%; max-height: 300px; }
  </style>
</head>
<body>
  <header>
    <h1>バーコードスキャナー</h1>
    <div id="weather">天気を取得中...</div>
  </header>

  <main>
    <div id="scanner-container">
      <video id="scanner"></video>
    </div>

    <div id="product-list">
      <h2>商品リスト</h2>
      <table id="products">
        <thead>
          <tr>
            <th>商品名</th>
            <th>価格</th>
            <th>個数</th>
          </tr>
        </thead>
        <tbody id="product-body"></tbody>
      </table>
      <div id="total-price">合計金額: ¥0</div>
    </div>
  </main>

  <audio id="beep-sound" src="beep.mp3" preload="auto"></audio>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

  <script>
    const RAKUTEN_APPID = "1085166348461729249"; // ← ここをあなたのIDに変更！

    const productBody = document.getElementById("product-body");
    const totalPriceEl = document.getElementById("total-price");
    const beep = document.getElementById("beep-sound");
    const cart = {};
    let lastCode = null;

    function updateTable() {
      productBody.innerHTML = '';
      let total = 0;
      for (const code in cart) {
        const item = cart[code];
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${item.name}</td><td>¥${item.price}</td><td>${item.qty}</td>`;
        productBody.appendChild(tr);
        total += item.price * item.qty;
      }
      totalPriceEl.textContent = `合計金額: ¥${total}`;
    }

    function fetchProduct(code) {
      fetch(`https://app.rakuten.co.jp/services/api/IchibaItem/Search/20170706?format=json&applicationId=${RAKUTEN_APPID}&jan=${code}&hits=1`)
        .then(res => res.json())
        .then(data => {
          const item = data.Items?.[0]?.Item;
          const name = item?.itemName || "不明";
          const price = parseInt(item?.itemPrice || prompt("価格を入力してください"), 10);
          if (!cart[code]) {
            cart[code] = { name, price, qty: 1 };
          } else {
            cart[code].qty++;
          }
          beep.play();
          updateTable();
        })
        .catch(err => {
          alert("商品取得に失敗しました");
          console.error(err);
        });
    }

    function startScanner() {
      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.querySelector('#scanner'),
          constraints: {
            facingMode: "environment"
          }
        },
        decoder: {
          readers: ["ean_reader", "ean_13_reader"]
        }
      }, err => {
        if (err) {
          console.error(err);
          return;
        }
        Quagga.start();
      });

      Quagga.onDetected(result => {
        const code = result.codeResult.code;
        if (code && code !== lastCode) {
          lastCode = code;
          fetchProduct(code);
          setTimeout(() => { lastCode = null }, 2000); // 2秒間再スキャン防止
        }
      });
    }

    function getWeatherText(code) {
      const map = {
        0: "快晴", 1: "晴れ", 2: "やや曇り", 3: "曇り",
        45: "霧", 48: "霧", 51: "霧雨", 53: "霧雨", 55: "霧雨",
        61: "弱い雨", 63: "雨", 65: "強い雨",
        66: "氷雨", 67: "氷雨", 71: "弱い雪", 73: "雪", 75: "強い雪",
        80: "にわか雨", 81: "雨", 82: "激しい雨", 95: "雷雨", 99: "雷雨"
      };
      return map[code] || "不明";
    }

    function getWeather() {
      navigator.geolocation?.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&timezone=Asia/Tokyo`)
          .then(res => res.json())
          .then(data => {
            const weather = data.current_weather;
            const text = getWeatherText(weather.weathercode);
            document.getElementById("weather").textContent = `現在の天気：${text}（${weather.temperature}℃）`;
          })
          .catch(() => {
            document.getElementById("weather").textContent = "天気取得失敗";
          });
      }, () => {
        document.getElementById("weather").textContent = "位置情報が取得できません";
      });
    }

    getWeather();
    startScanner();
  </script>
</body>
</html>
