<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ショピマネ - リアルタイム共有</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f0e68c;
      padding: 1em;
      margin: 0;
    }
    h1 {
      text-align: center;
      color: #2c3e50;
    }
    #reader {
      width: 100%;
      max-width: 400px;
      margin: 1em auto;
      border: 2px solid #ccc;
      border-radius: 12px;
      overflow: hidden;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1em;
      background: white;
      border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 0.7em;
      text-align: center;
    }
    th {
      background-color: #3498db;
      color: white;
    }
    button {
      padding: 0.3em 0.7em;
      margin: 0.2em;
      border: none;
      border-radius: 5px;
      background: #3498db;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #2980b9;
    }
    #controls {
      text-align: center;
      margin: 1em 0;
    }
    #scan-result, #total {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>📷 ショピマネ（リアルタイム共有）</h1>
  <div id="controls">
    <label for="listId">リストID:</label>
    <input type="text" id="listId" placeholder="例: mylist">
    <button onclick="connectList()">接続</button>
  </div>
  <div id="reader"></div>
  <p>読み取りコード：<span id="scan-result">---</span></p>
  <p>合計金額：<strong id="total">0</strong> 円</p>
  <table>
    <thead>
      <tr><th>商品</th><th>価格</th><th>個数</th><th>操作</th></tr>
    </thead>
    <tbody id="cart-body"></tbody>
  </table>
  <audio id="beep-sound" src="beep.mp3" preload="auto"></audio>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBaVYdsPFjVDZK9K_3_BvJxnCpbVneyplQ",
  authDomain: "syopimane.firebaseapp.com",
  projectId: "syopimane",
  storageBucket: "syopimane.firebasestorage.app",
  messagingSenderId: "290212774909",
  appId: "1:290212774909:web:a70e8096d44b56cc744f94",
  measurementId: "G-7Z98JZQ2F1"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  let listRef;
  let listId = "";
  let cart = {};
  let html5QrCode;
  let lastScanned = null;
  let paused = false;

  function connectList() {
    listId = document.getElementById("listId").value.trim();
    if (!listId) return alert("リストIDを入力してください");
    listRef = db.ref("lists/" + listId);
    listRef.on("value", snapshot => {
      const val = snapshot.val();
      if (val) {
        cart = val;
        updateCart();
      }
    });
  }

  function updateCart() {
    const cartBody = document.getElementById("cart-body");
    const totalEl = document.getElementById("total");
    cartBody.innerHTML = "";
    let total = 0;
    for (const code in cart) {
      const item = cart[code];
      const subtotal = item.price * item.qty;
      total += subtotal;
      const row = document.createElement("tr");
      row.innerHTML = `
        <td contenteditable onblur="editName('${code}', this.textContent)">${item.name}</td>
        <td contenteditable onblur="editPrice('${code}', this.textContent)">${item.price}</td>
        <td>${item.qty}</td>
        <td>
          <button onclick="changeQty('${code}', -1)">−</button>
          <button onclick="changeQty('${code}', 1)">＋</button>
          <button onclick="removeItem('${code}')">🗑️</button>
        </td>
      `;
      cartBody.appendChild(row);
    }
    totalEl.textContent = total;
  }

  function editName(code, name) {
    cart[code].name = name;
    saveCart();
  }

  function editPrice(code, price) {
    const p = parseInt(price);
    if (!isNaN(p)) {
      cart[code].price = p;
      saveCart();
    }
  }

  function changeQty(code, delta) {
    cart[code].qty += delta;
    if (cart[code].qty <= 0) delete cart[code];
    saveCart();
  }

  function removeItem(code) {
    delete cart[code];
    saveCart();
  }

  function saveCart() {
    if (listRef) listRef.set(cart);
  }

  function onScan(code) {
    if (paused || code === lastScanned) return;
    paused = true;
    lastScanned = code;
    document.getElementById("scan-result").textContent = code;
    document.getElementById("beep-sound").play();
    if (cart[code]) {
      cart[code].qty++;
      saveCart();
      resumeScan();
    } else {
      const name = prompt("商品名を入力してください：") || "不明";
      const price = parseInt(prompt("価格を入力してください："), 10);
      if (isNaN(price)) {
        alert("価格が無効です");
        resumeScan();
        return;
      }
      cart[code] = { name, price, qty: 1 };
      saveCart();
      resumeScan();
    }
  }

  function resumeScan() {
    setTimeout(() => { paused = false; lastScanned = null; }, 1000);
  }

  Html5Qrcode.getCameras().then(devices => {
    const camId = devices[0].id;
    html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start(camId, { fps: 10, qrbox: 250 }, onScan);
  });
</script>
</body>
</html>
